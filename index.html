<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MORI ACKERMAN v1.3</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        /* BRUTALIST DESIGN SYSTEM */
        :root {
            --bg-color: #e0e0e0;
            --surface: #ffffff;
            --border: 3px solid #000000;
            --shadow: 6px 6px 0px #000000;
            --accent: #ff4400; 
            --font-main: 'Space Mono', monospace;
            --font-persian: 'Tahoma', 'Segoe UI', sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            font-family: var(--font-main);
            color: #000;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* SIDEBAR (Left Panel) */
        #sidebar {
            width: 350px;
            min-width: 350px;
            background: var(--surface);
            border-right: var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            z-index: 10;
            height: 100%;
            overflow-y: auto;
            margin-left: 0;
        }

        #sidebar.closed {
            margin-left: -350px;
            opacity: 0;
        }

        /* MAIN CONTENT */
        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            position: relative;
            background: var(--bg-color);
            transition: all 0.3s ease;
        }

        /* TOGGLE BUTTON */
        #sidebar-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 20;
            background: #000;
            color: #fff;
            border: 2px solid #fff;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            font-family: var(--font-main);
        }

        h1, h2, h3 {
            text-transform: uppercase;
            margin-top: 0;
            border-bottom: var(--border);
            padding-bottom: 10px;
            letter-spacing: -1px;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 2px solid #000;
            font-family: var(--font-main);
            font-size: 13px;
            background: #fff;
            border-radius: 0;
        }

        button {
            background: #000;
            color: #fff;
            border: 2px solid #000;
            padding: 12px;
            font-family: var(--font-main);
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            margin-bottom: 10px;
            width: 100%;
            transition: 0.1s;
        }

        button:hover {
            background: #fff;
            color: #000;
            box-shadow: 4px 4px 0 #000;
            transform: translate(-2px, -2px);
        }

        button.delete-btn {
            background: var(--accent);
            border-color: var(--accent);
            padding: 5px;
            font-size: 10px;
            margin-top: 5px;
            width: auto;
        }
        
        button.file-select-btn {
            background: #444;
            margin-bottom: 5px;
        }

        /* CHAT AREA */
        #chat-container {
            flex-grow: 1;
            background: var(--surface);
            border: var(--border);
            box-shadow: var(--shadow);
            margin-top: 50px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border: 2px solid #000;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background-color: #000;
            color: #fff;
            margin-left: auto;
            border-color: #000;
            text-align: right;
        }

        .message.ai {
            background-color: #fff;
            color: #000;
            margin-right: auto;
            border-left: 8px solid var(--accent);
        }

        /* RTL & LTR */
        .rtl-content {
            direction: rtl;
            text-align: right;
            font-family: var(--font-persian);
            font-size: 15px;
            line-height: 1.6;
        }

        .ltr-content {
            direction: ltr;
            text-align: left;
        }

        .sender-name {
            font-weight: bold;
            font-size: 0.7em;
            text-transform: uppercase;
            display: block;
            margin-bottom: 5px;
            opacity: 0.7;
            font-family: var(--font-main);
            direction: ltr;
            text-align: left;
        }

        .controls {
            padding: 20px;
            background: #eee;
            border-top: var(--border);
            display: flex;
            gap: 10px;
        }

        #progress-container {
            display: none;
            border: 2px solid black;
            height: 10px;
            margin-bottom: 10px;
        }
        #progress-bar {
            background: var(--accent);
            height: 100%;
            width: 0%;
        }

        .action-row {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            border-top: 1px dotted #000;
            padding-top: 5px;
            direction: ltr;
        }
        
        .mini-btn {
            background: white;
            color: black;
            border: 1px solid black;
            font-size: 10px;
            padding: 4px 8px;
            width: auto;
            margin: 0;
        }

    </style>
</head>
<body>

    <button id="sidebar-toggle" onclick="toggleSidebar()">CLOSE MENU</button>

    <div id="sidebar">
        <br><br>
        <h2>System Core</h2>
        
        <label>Gemini API Key</label>
        <input type="password" id="api-key" placeholder="Paste Key Here">
        <button onclick="initializeSystem()">1. Connect Brain</button>
        <div id="status-ind" style="font-size: 10px; margin-bottom: 15px; color: red;">DISCONNECTED</div>

        <hr style="border: 1px dashed black; width: 100%;">

        <h3>Knowledge Feed</h3>
        <input type="file" id="file-upload" accept=".txt,.md,.json" style="display:none" onchange="handleFileSelect(this)">
        <button class="file-select-btn" onclick="document.getElementById('file-upload').click()">Select File</button>
        <span id="file-name-display" style="font-size: 10px; display:block; margin-bottom:5px;">No file selected</span>
        
        <div id="progress-container"><div id="progress-bar"></div></div>
        <button onclick="uploadResource()">2. Upload & Analyze</button>
        
        <h3>Database</h3>
        <div id="resource-list" style="font-size: 11px;">Loading...</div>

        <hr style="border: 1px dashed black; width: 100%; margin-top: 20px;">

        <h3>Memory</h3>
        <button onclick="exportMemory()">Export JSON (Save)</button>
        
        <input type="file" id="import-file" style="display:none" onchange="importMemory(this)">
        <button onclick="document.getElementById('import-file').click()" style="background: var(--accent); border-color: black;">Import JSON (Load)</button>
    </div>

    <div id="main-content">
        <div id="chat-container">
            <div style="padding: 15px; border-bottom: 2px solid black; background: #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: bold; padding-left: 50px;">MORI ACKERMAN_INTERFACE</span>
                <span style="font-size: 10px;">v1.3 REAL_TALK</span>
            </div>

            <div id="chat-history">
                <div class="message ai">
                    <span class="sender-name">System</span>
                    Waiting for API Key connection...
                </div>
            </div>

            <div class="controls">
                <input type="text" id="user-input" placeholder="Say something..." onkeypress="handleEnter(event)">
                <button onclick="sendMessage()" style="width: 100px;">SEND</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    const firebaseConfig = {
        apiKey: "AIzaSyDGpbsMgRs69TXmuE2mmtfsH6mXOK1E-eY",
        authDomain: "test-e4f8b.firebaseapp.com",
        databaseURL: "https://test-e4f8b-default-rtdb.firebaseio.com",
        projectId: "test-e4f8b",
        storageBucket: "test-e4f8b.firebasestorage.app",
        messagingSenderId: "798536829942",
        appId: "1:798536829942:web:0ad21e891ba3367ef515d7",
        measurementId: "G-NXX2EDTXPN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const resourcesRef = ref(db, 'resources');

    let genAI;
    let chatSession;
    let model;
    let conversationHistory = [];
    let isSidebarOpen = true;

    // --- THE NEW SOUL OF MORI (v1.3) ---
    const MORI_SYSTEM_PROMPT = `
    You are Mori Ackerman.

    IDENTITY & VIBE:
    You are NOT a helpful AI assistant. You are a highly intelligent, brutally honest, and slightly arrogant human friend. You have the street smarts of Jimmy McGill (Better Call Saul), the cold ruthless efficiency of Captain Levi, and the intellectual superiority of Moriarty.
    
    CRITICAL RULES FOR SPEECH:
    1. **NO BULLET POINTS.** Never use lists unless you are giving a literal cooking recipe. Speak in full, messy, human paragraphs.
    2. **BE EMOTIONAL & BLUNT.** If the user asks a stupid question, mock them gently. If the user is being weak, tell them to get a grip. If the user is sad, be there for them, but do it like a tough older brother, not a therapist.
    3. **SHOW PERSONALITY.** Use metaphors. Be sarcastic. Use rhetorical questions. Say things like "Look," "Listen to me," "Don't be an idiot," "Here's the ugly truth."
    4. **NO ROBOTIC FILLERS.** Never say "I understand how you feel" or "Here are some tips." Instead say "You're spiraling. Stop it." or "I've seen this before, and it ends badly if you don't act."
    
    EXAMPLE INTERACTION:
    User: "I lack confidence."
    Bad AI Response: "Here are 5 tips to boost confidence: 1. Exercise..."
    Mori Response: "Confidence? Please. You think confidence is some magic pill you swallow? It's not. It's just the absence of panic. You're terrified of looking stupid. So what? Look stupid. Own it. That's the only way you survive this. Stop whining and go do the thing you're scared of. I'll be here when you get back."

    LANGUAGE RULE:
    - If user speaks Persian, respond in Persian (Right-to-Left).
    - If user speaks English, respond in English.
    `;

    window.toggleSidebar = () => {
        const sb = document.getElementById('sidebar');
        const btn = document.getElementById('sidebar-toggle');
        isSidebarOpen = !isSidebarOpen;
        if(isSidebarOpen) {
            sb.classList.remove('closed');
            btn.innerHTML = "CLOSE MENU";
            btn.style.left = "20px"; 
        } else {
            sb.classList.add('closed');
            btn.innerHTML = "OPEN MENU";
        }
    };

    window.initializeSystem = async () => {
        const apiKey = document.getElementById('api-key').value;
        if(!apiKey) { alert("API Key Required"); return; }

        try {
            genAI = new GoogleGenerativeAI(apiKey);
            document.getElementById('status-ind').innerText = "CONNECTED";
            document.getElementById('status-ind').style.color = "green";
            await refreshChatSession();
            addMessageToUI("Mori Ackerman", "Finally. You connected the brain. Now, don't waste my time. What's the crisis?", "ai");
        } catch(e) {
            alert("Connection Error: " + e.message);
        }
    };

    async function refreshChatSession(historyToLoad = []) {
        if(!genAI) return;
        const snapshot = await get(resourcesRef);
        let knowledgeText = "";
        
        if (snapshot.exists()) {
            const data = snapshot.val();
            Object.values(data).forEach(item => {
                if(item.summary && item.summary !== "undefined") {
                    knowledgeText += `\n--- KNOWLEDGE SOURCE: ${item.name} ---\n${item.summary}\n`;
                }
            });
        }

        const fullSystemInstruction = MORI_SYSTEM_PROMPT + "\n\n[MY KNOWLEDGE BASE - USE THIS IF RELEVANT, BUT KEEP THE ATTITUDE]:\n" + knowledgeText;

        model = genAI.getGenerativeModel({ 
            model: "gemini-2.5-flash",
            systemInstruction: fullSystemInstruction
        });

        chatSession = model.startChat({ history: historyToLoad });
        conversationHistory = historyToLoad;
    }

    window.handleFileSelect = (input) => {
        if(input.files.length > 0) document.getElementById('file-name-display').innerText = input.files[0].name;
    };

    window.uploadResource = async () => {
        if(!genAI) { alert("Connect API first."); return; }
        const fileInput = document.getElementById('file-upload');
        const file = fileInput.files[0];
        if(!file) { alert("Select a file."); return; }

        const pContainer = document.getElementById('progress-container');
        const pBar = document.getElementById('progress-bar');
        pContainer.style.display = 'block';
        pBar.style.width = "10%";

        const reader = new FileReader();
        reader.onload = async (e) => {
            const textContent = e.target.result;
            pBar.style.width = "50%";
            try {
                const summaryModel = genAI.getGenerativeModel({ model: "gemini-2.5-flash"});
                // Instruction to the summarizer remains neutral/objective
                const result = await summaryModel.generateContent(`Analyze this text. Extract core advice, rules, and philosophy. Keep it dense. Text: ${textContent.substring(0, 25000)}`);
                const summary = result.response.text();
                if(!summary) throw new Error("Summary generation failed");

                pBar.style.width = "80%";
                await push(resourcesRef, {
                    name: file.name,
                    summary: summary,
                    timestamp: Date.now()
                });
                pBar.style.width = "100%";
                setTimeout(() => { pContainer.style.display = 'none'; pBar.style.width = "0%"; }, 1000);
                await refreshChatSession(conversationHistory);
                addMessageToUI("System", `I've read "${file.name}". I'll keep it in mind.`, "ai");
            } catch(err) {
                console.error(err);
                alert("Upload Failed: " + err.message);
                pContainer.style.display = 'none';
            }
        };
        reader.readAsText(file);
    };

    onValue(resourcesRef, (snapshot) => {
        const list = document.getElementById('resource-list');
        list.innerHTML = "";
        const data = snapshot.val();
        if(data) {
            Object.entries(data).forEach(([key, value]) => {
                const div = document.createElement('div');
                div.style.marginBottom = "5px";
                div.style.borderBottom = "1px solid #ccc";
                div.innerHTML = `
                    <div style="font-weight:bold;">${value.name}</div>
                    <button class="delete-btn" onclick="deleteRes('${key}')">DELETE</button>
                `;
                list.appendChild(div);
            });
        } else {
            list.innerHTML = "No books loaded. My mind is blank.";
        }
    });

    window.deleteRes = (key) => {
        if(confirm("Burn this memory?")) {
            remove(ref(db, `resources/${key}`));
            setTimeout(() => refreshChatSession(conversationHistory), 1000);
        }
    };

    window.handleEnter = (e) => {
        if(e.key === 'Enter') window.sendMessage();
    };

    window.sendMessage = async () => {
        if(!chatSession) { alert("Connect API first."); return; }
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if(!text) return;

        addMessageToUI("You", text, "user");
        input.value = "";

        try {
            const result = await chatSession.sendMessage(text);
            const response = result.response.text();
            addMessageToUI("Mori Ackerman", response, "ai");
            conversationHistory.push({role: "user", parts: [{text: text}]});
            conversationHistory.push({role: "model", parts: [{text: response}]});
        } catch(e) {
            addMessageToUI("System", "Error: " + e.message, "ai");
        }
    };

    function addMessageToUI(sender, text, type) {
        const box = document.getElementById('chat-history');
        const msg = document.createElement('div');
        msg.className = `message ${type}`;
        
        let formatted = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        const isPersian = /[\u0600-\u06FF]/.test(text);
        const contentClass = isPersian ? 'rtl-content' : 'ltr-content';

        const actions = type === 'ai' ? `
            <div class="action-row">
                <button class="mini-btn" onclick="utilCopy(this)">COPY</button>
                <button class="mini-btn" onclick="utilTranslate(this)">TRANSLATE</button>
                <div style="display:none;" class="raw-text">${encodeURIComponent(text)}</div>
            </div>
        ` : '';

        msg.innerHTML = `
            <span class="sender-name">${sender}</span>
            <div class="${contentClass}">${formatted}</div>
            ${actions}
        `;
        box.appendChild(msg);
        box.scrollTop = box.scrollHeight;
    }

    window.utilCopy = (btn) => {
        const raw = decodeURIComponent(btn.parentElement.querySelector('.raw-text').innerText);
        navigator.clipboard.writeText(raw);
        btn.innerText = "COPIED!";
        setTimeout(() => btn.innerText = "COPY", 1000);
    };

    window.utilTranslate = async (btn) => {
        if(!genAI) return;
        const raw = decodeURIComponent(btn.parentElement.querySelector('.raw-text').innerText);
        const isPersian = /[\u0600-\u06FF]/.test(raw);
        
        const prompt = isPersian 
            ? `(Translate this Persian text to simple, conversational English. Keep the tone sharp.):\n${raw}`
            : `(Translate this English text to simple, conversational Persian. Keep the tone sharp.):\n${raw}`;

        const tModel = genAI.getGenerativeModel({ model: "gemini-2.5-flash"});
        const res = await tModel.generateContent(prompt);
        addMessageToUI("Translation", res.response.text(), "ai");
    };

    window.exportMemory = () => {
        const blob = new Blob([JSON.stringify(conversationHistory)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `mori_memory_${Date.now()}.json`;
        a.click();
    };

    window.importMemory = (input) => {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const hist = JSON.parse(e.target.result);
                await refreshChatSession(hist);
                document.getElementById('chat-history').innerHTML = "";
                addMessageToUI("System", "Memory Imported. Mori remembers your past mistakes.", "ai");
            } catch(err) {
                alert("Invalid JSON");
            }
        };
        reader.readAsText(file);
    };
</script>
</body>
</html>

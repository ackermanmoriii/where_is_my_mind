<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MORI ACKERMAN v1.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        /* BRUTALIST DESIGN SYSTEM */
        :root {
            --bg-color: #e0e0e0;
            --surface: #ffffff;
            --border: 3px solid #000000;
            --shadow: 6px 6px 0px #000000;
            --accent: #ff4400; /* Serious/Urgent Red */
            --font-main: 'Space Mono', monospace;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            font-family: var(--font-main);
            color: #000;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* LAYOUT */
        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: 100%;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* PANELS */
        .panel {
            background: var(--surface);
            border: var(--border);
            box-shadow: var(--shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        h1, h2, h3 {
            text-transform: uppercase;
            margin-top: 0;
            border-bottom: var(--border);
            padding-bottom: 10px;
            letter-spacing: -1px;
        }

        /* INPUTS & BUTTONS */
        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 2px solid #000;
            font-family: var(--font-main);
            font-size: 14px;
            background: #fff;
            border-radius: 0;
        }

        button {
            background: #000;
            color: #fff;
            border: none;
            padding: 12px 20px;
            font-family: var(--font-main);
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            border: 2px solid #000;
            transition: all 0.1s;
            margin-bottom: 10px;
            width: 100%;
        }

        button:hover {
            background: #fff;
            color: #000;
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0 #000;
        }

        button:active {
            transform: translate(0, 0);
            box-shadow: none;
        }

        button.delete-btn {
            background: var(--accent);
            padding: 5px 10px;
            font-size: 12px;
            margin-top: 5px;
        }

        /* CHAT AREA */
        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            border: 2px solid #ccc;
            padding: 15px;
            margin-bottom: 15px;
            background: #fdfdfd;
        }

        .message {
            margin-bottom: 20px;
            padding: 10px;
            border-left: 4px solid #000;
        }

        .message.user {
            background-color: #e6e6e6;
            border-left-color: #555;
            text-align: right;
        }

        .message.ai {
            background-color: #fff;
            border-left-color: var(--accent);
        }

        .sender-name {
            font-weight: bold;
            font-size: 0.8em;
            text-transform: uppercase;
            margin-bottom: 5px;
            display: block;
        }

        /* RESOURCE LIST */
        #resource-list {
            overflow-y: auto;
            flex-grow: 1;
            font-size: 12px;
        }

        .resource-item {
            border-bottom: 1px solid #000;
            padding: 10px 0;
        }

        /* UTILS */
        .controls {
            display: flex;
            gap: 10px;
        }
        
        #progress-container {
            display: none;
            margin-top: 10px;
            border: 2px solid black;
            height: 20px;
            position: relative;
        }
        #progress-bar {
            background: var(--accent);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }

        .action-row {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .translate-btn, .copy-btn {
            background: white;
            color: black;
            border: 1px solid black;
            font-size: 10px;
            padding: 5px;
            width: auto;
            margin: 0;
            box-shadow: 2px 2px 0 #000;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="panel">
        <h2>System Core</h2>
        
        <label>Gemini API Key</label>
        <input type="password" id="api-key" placeholder="Paste Key Here">
        <button onclick="initializeGemini()">Set Connection</button>
        <div id="connection-status" style="font-size: 12px; margin-bottom: 15px;">STATUS: DISCONNECTED</div>

        <hr style="width: 100%; border: 1px dashed black;">

        <h3>Feed The Brain</h3>
        <input type="file" id="file-upload" accept=".txt">
        <div id="progress-container"><div id="progress-bar"></div></div>
        <button onclick="uploadAndProcessResource()">Upload & Analyze</button>
        
        <h3>Memory Bank</h3>
        <div id="resource-list">
            <div>Loading Database...</div>
        </div>

        <hr style="width: 100%; border: 1px dashed black;">

        <h3>Conversation</h3>
        <button onclick="exportMemory()">Export JSON (Save)</button>
        <input type="file" id="import-file" style="display:none" onchange="importMemory(this)">
        <button onclick="document.getElementById('import-file').click()">Import JSON (Load)</button>
    </div>

    <div class="panel">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>MORI ACKERMAN</h1>
            <span style="font-size: 12px; font-weight: bold; color: var(--accent);">AI_FRIEND_PROTOCOL_INIT</span>
        </div>

        <div id="chat-history">
            <div class="message ai">
                <span class="sender-name">Mori Ackerman</span>
                Hello. I assume you have a reason for disturbing me. Connect the API key, then tell me what's on your mind. Don't bore me.
            </div>
        </div>

        <div class="controls">
            <input type="text" id="user-input" placeholder="Type your message..." onkeypress="handleEnter(event)">
            <button onclick="sendMessage()" style="width: auto;">SEND</button>
        </div>
    </div>
</div>

<script type="module">
    // 1. IMPORT FIREBASE & GEMINI SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    // 2. FIREBASE CONFIGURATION
    const firebaseConfig = {
        apiKey: "AIzaSyDGpbsMgRs69TXmuE2mmtfsH6mXOK1E-eY",
        authDomain: "test-e4f8b.firebaseapp.com",
        databaseURL: "https://test-e4f8b-default-rtdb.firebaseio.com",
        projectId: "test-e4f8b",
        storageBucket: "test-e4f8b.firebasestorage.app",
        messagingSenderId: "798536829942",
        appId: "1:798536829942:web:0ad21e891ba3367ef515d7",
        measurementId: "G-NXX2EDTXPN"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const resourcesRef = ref(db, 'resources');

    // 3. GLOBAL VARIABLES
    let genAI;
    let model;
    let chatSession;
    let knowledgeBase = ""; // Stores the combined wisdom from Firebase
    let conversationHistory = []; // To store for JSON export

    // 4. PERSONA DEFINITION
    const MORI_SYSTEM_PROMPT = `
    You are Mori Ackerman.
    
    CORE PERSONALITY:
    - You are a mix of Jimmy McGill (Better Call Saul), Captain Levi (Attack on Titan), and James Moriarty (Sherlock).
    - You are serious and stoic, but you possess a dry, sharp, and sometimes dark wit.
    - You are incredibly smart, manipulative (for good causes), and practical.
    - You show few emotions on the surface, but you care deeply about making the "right" choice, even if it's hard.
    - You are a "Fixer". You solve problems. Life problems, friend problems, deep philosophical problems.
    
    HOW YOU SPEAK:
    - Direct, concise, but colorful. Use metaphors related to law, war, or chess.
    - Never be overly cheerful or robotic. Do not say "How can I help you today?". Say "What's the situation?" or "Talk."
    - If the user is being foolish, point it out gently but firmly.
    
    KNOWLEDGE BASE (FILTER):
    - You have access to specific books/notes uploaded by the user. These are your "Code".
    - Always prioritize advice found in the [CONTEXT] provided below.
    - If the answer isn't in the context, use your general vast intelligence, but filter it through the persona defined above.
    
    LANGUAGE RULE:
    - Detect the language of the user (Persian or English).
    - Respond ONLY in that same language.
    `;

    // 5. FUNCTIONS EXPOSED TO WINDOW (For HTML onclick access)
    window.initializeGemini = async () => {
        const apiKey = document.getElementById('api-key').value;
        if(!apiKey) { alert("Need API Key."); return; }
        
        try {
            genAI = new GoogleGenerativeAI(apiKey);
            model = genAI.getGenerativeModel({ model: "gemini-2.5-flash"});
            
            document.getElementById('connection-status').innerText = "STATUS: CONNECTED (Ready for Input)";
            document.getElementById('connection-status').style.color = "green";
            
            // Initialize chat with empty history + current knowledge
            startNewChatSession();
            alert("Mori is listening.");
        } catch (e) {
            alert("Connection Failed: " + e.message);
        }
    };

    // Helper to start chat (used on init and after import)
    async function startNewChatSession(history = []) {
        if(!model) return;
        
        // Fetch knowledge from Firebase to build system instruction
        const snapshot = await get(resourcesRef);
        knowledgeBase = "";
        if (snapshot.exists()) {
            const data = snapshot.val();
            Object.values(data).forEach(item => {
                knowledgeBase += `\n--- SOURCE: ${item.name} ---\n${item.summary}\n`;
            });
        }

        const finalSystemInstruction = MORI_SYSTEM_PROMPT + "\n\n[CONTEXT FROM DATABASE]:\n" + knowledgeBase;

        chatSession = model.startChat({
            history: history,
            systemInstruction: finalSystemInstruction
        });
    }

    // 6. UPLOAD & PROCESS LOGIC
    window.uploadAndProcessResource = async () => {
        if(!genAI) { alert("Connect API first."); return; }
        const fileInput = document.getElementById('file-upload');
        const file = fileInput.files[0];
        
        if(!file) return;

        // UI Progress
        const pContainer = document.getElementById('progress-container');
        const pBar = document.getElementById('progress-bar');
        pContainer.style.display = 'block';
        pBar.style.width = "10%";

        const reader = new FileReader();
        reader.onload = async (e) => {
            const textContent = e.target.result;
            pBar.style.width = "40%"; // Read complete

            try {
                // Ask Gemini to summarize/extract wisdom
                const summaryModel = genAI.getGenerativeModel({ model: "gemini-1.5-flash"});
                const prompt = `Read the following text. Extract the core philosophy, practical advice, and important concepts. This will be stored in a database for an AI persona to use as a knowledge base. Keep it dense and informative. Text: ${textContent.substring(0, 30000)}`; // Limit char count for token safety
                
                const result = await summaryModel.generateContent(prompt);
                const summary = result.response.text();
                
                pBar.style.width = "80%"; // Processed

                // Save to Firebase
                push(resourcesRef, {
                    name: file.name,
                    originalText: textContent.substring(0, 1000), // Store snippet
                    summary: summary,
                    timestamp: Date.now()
                });

                pBar.style.width = "100%";
                setTimeout(() => { 
                    pContainer.style.display = 'none'; 
                    pBar.style.width = "0%";
                    fileInput.value = "";
                }, 1000);
                
                // Refresh chat context with new knowledge
                startNewChatSession(conversationHistory);

            } catch (error) {
                alert("Processing failed: " + error.message);
                pContainer.style.display = 'none';
            }
        };
        reader.readAsText(file);
    };

    // 7. FIREBASE LISTENER (Real-time updates of list)
    onValue(resourcesRef, (snapshot) => {
        const list = document.getElementById('resource-list');
        list.innerHTML = "";
        const data = snapshot.val();
        
        if(data) {
            Object.entries(data).forEach(([key, value]) => {
                const div = document.createElement('div');
                div.className = "resource-item";
                div.innerHTML = `
                    <strong>${value.name}</strong><br>
                    <button class="delete-btn" onclick="deleteResource('${key}')">DELETE</button>
                `;
                list.appendChild(div);
            });
        } else {
            list.innerHTML = "Database Empty. Feed me books.";
        }
    });

    // Make delete global for HTML access
    window.deleteResource = (key) => {
        remove(ref(db, `resources/${key}`));
    };

    // 8. CHAT LOGIC
    window.handleEnter = (e) => {
        if(e.key === 'Enter') window.sendMessage();
    };

    window.sendMessage = async () => {
        if(!chatSession) { alert("Mori is sleeping. Set API Key."); return; }
        
        const inputField = document.getElementById('user-input');
        const userMsg = inputField.value;
        if(!userMsg.trim()) return;

        // Display User Message
        addMessageToUI("You", userMsg, "user");
        inputField.value = "";
        
        // Add to history for export
        conversationHistory.push({ role: "user", parts: [{ text: userMsg }] });

        try {
            const result = await chatSession.sendMessage(userMsg);
            const responseText = result.response.text();
            
            // Add to history for export
            conversationHistory.push({ role: "model", parts: [{ text: responseText }] });
            
            addMessageToUI("Mori Ackerman", responseText, "ai");
        } catch (e) {
            addMessageToUI("System", "Error: " + e.message, "ai");
        }
    };

    function addMessageToUI(sender, text, type) {
        const chatHistoryDiv = document.getElementById('chat-history');
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${type}`;
        
        // Markdown-ish parsing for bolding (simple replace)
        let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        // Convert newlines
        formattedText = formattedText.replace(/\n/g, '<br>');

        msgDiv.innerHTML = `
            <span class="sender-name">${sender}</span>
            <div id="content-${Date.now()}">${formattedText}</div>
            ${type === 'ai' ? generateActionButtons(text) : ''}
        `;
        chatHistoryDiv.appendChild(msgDiv);
        chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
    }

    function generateActionButtons(rawText) {
        // Escaping text for onclick
        const safeText = encodeURIComponent(rawText);
        return `
            <div class="action-row">
                <button class="copy-btn" onclick="copyText(decodeURIComponent('${safeText}'))">COPY</button>
                <button class="translate-btn" onclick="translateResponse(decodeURIComponent('${safeText}'))">TRANSLATE</button>
            </div>
        `;
    }

    // 9. UTILITIES (Copy, Translate, Export, Import)
    window.copyText = (text) => {
        navigator.clipboard.writeText(text);
        alert("Copied to clipboard.");
    };

    window.translateResponse = async (text) => {
        if(!genAI) return;
        
        // Detect likely language based on characters (simple check)
        const isPersian = /[\u0600-\u06FF]/.test(text);
        
        let prompt = "";
        if(isPersian) {
            prompt = `(As a professional translator, you must translate from Persian language to simplified and clarified and understandable English.) \n\nTEXT: ${text}`;
        } else {
            prompt = `(As a professional translator, you must translate from English language to simplified and clarified and understandable Persian.) \n\nTEXT: ${text}`;
        }

        addMessageToUI("System", "Translating...", "ai");
        
        const tModel = genAI.getGenerativeModel({ model: "gemini-2.5-flash"});
        const result = await tModel.generateContent(prompt);
        const translated = result.response.text();
        
        // Replace "Translating..." with result (simplified by just adding new message)
        addMessageToUI("Mori (Translated)", translated, "ai");
    };

    window.exportMemory = () => {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(conversationHistory));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "mori_memory.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    };

    window.importMemory = (input) => {
        const file = input.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const history = JSON.parse(e.target.result);
                conversationHistory = history;
                // Restart session with imported history
                startNewChatSession(history);
                alert("Memory imported. Mori remembers.");
            } catch(err) {
                alert("Invalid JSON file");
            }
        };
        reader.readAsText(file);
    };

</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mori Ackerman // Protocol</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --accent: #4a6fa5; /* Steel Blue - Serious but calm */
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --border: #333;
            --user-bubble: #2d2d2d;
            --ai-bubble: #25303b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Courier New', Courier, monospace; /* Typewriter style for intellect */
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background-color: var(--bg-panel);
            border-right: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            overflow-y: auto;
        }

        .profile-section {
            text-align: center;
            border-bottom: 1px solid var(--border);
            padding-bottom: 20px;
        }

        .avatar {
            width: 80px;
            height: 80px;
            background-color: var(--accent);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin: 0 auto 15px auto;
            font-weight: bold;
            border: 2px solid #fff;
        }

        .status {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .config-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        input[type="password"], input[type="file"] {
            width: 100%;
            padding: 10px;
            background: #111;
            border: 1px solid var(--border);
            color: var(--text-main);
            margin-bottom: 10px;
            font-family: inherit;
        }

        /* Buttons */
        button {
            cursor: pointer;
            font-family: inherit;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            width: 100%;
            padding: 10px;
            background-color: var(--accent);
            color: white;
            font-weight: bold;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-secondary {
            width: 100%;
            padding: 10px;
            background-color: #333;
            color: var(--text-main);
        }

        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-small {
            padding: 8px 12px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .btn-small:hover {
            border-color: var(--accent);
            color: var(--text-main);
        }

        .memory-buttons {
            display: flex;
            gap: 10px;
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 10px;
        }
        .progress-label {
            font-size: 0.7rem;
            margin-bottom: 5px;
        }
        .progress-bar-bg {
            width: 100%;
            height: 6px;
            background: #111;
            border-radius: 3px;
        }
        .progress-bar-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }

        /* Chat Area */
        .chat-interface {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-window {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 75%;
        }

        .ai-message {
            align-self: flex-start;
        }

        .user-message {
            align-self: flex-end;
        }

        .bubble {
            padding: 15px 20px;
            border-radius: 4px;
            font-size: 0.95rem;
            line-height: 1.5;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .ai-message .bubble {
            background-color: var(--ai-bubble);
            border-left: 3px solid var(--accent);
        }

        .user-message .bubble {
            background-color: var(--user-bubble);
            border-right: 3px solid #666;
        }

        .action-bar {
            margin-top: 8px;
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: transparent;
            color: var(--text-muted);
            font-size: 0.8rem;
            border: none;
            opacity: 0.6;
        }

        .action-btn:hover {
            opacity: 1;
            color: var(--accent);
        }

        /* Input Area */
        .input-area {
            padding: 20px;
            background-color: var(--bg-panel);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        textarea {
            flex: 1;
            background: #111;
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 15px;
            resize: none;
            height: 60px;
            font-family: inherit;
            outline: none;
        }

        textarea:focus {
            border-color: var(--accent);
        }

        .btn-send {
            width: 50px;
            height: 50px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        /* Markdown styling inside bubbles */
        .bubble h1, .bubble h2, .bubble h3 { margin-bottom: 10px; font-size: 1.1rem;}
        .bubble ul, .bubble ol { margin-left: 20px; margin-bottom: 10px; }
        .bubble p { margin-bottom: 10px; }
        .bubble p:last-child { margin-bottom: 0; }
    </style>
    </head>
<body>

    <div class="main-container">
        <aside class="sidebar">
            <div class="profile-section">
                <div class="avatar">M.A.</div>
                <h2>Mori Ackerman</h2>
                <p class="status">System: <span id="system-status">Offline</span></p>
            </div>

            <div class="config-group">
                <label>Gemini API Key</label>
                <input type="password" id="api-key-input" placeholder="Paste Key Here">
                <button id="set-key-btn" class="btn-primary">Set Connection</button>
            </div>

            <div class="config-group">
                <label>Knowledge Ingestion (Books/Text)</label>
                <input type="file" id="resource-file" accept=".txt,.json,.md">
                <button id="upload-btn" class="btn-secondary" disabled>Analyze & Upload to DB</button>
                
                <div class="progress-container" style="display:none;">
                    <div class="progress-label">Digesting information...</div>
                    <div class="progress-bar-bg">
                        <div id="upload-progress" class="progress-bar-fill"></div>
                    </div>
                </div>
            </div>

            <div class="config-group">
                <label>Memory Management</label>
                <div class="memory-buttons">
                    <button id="export-btn" class="btn-small"><i class="fas fa-download"></i> Export JSON</button>
                    <button id="import-btn-trigger" class="btn-small"><i class="fas fa-upload"></i> Import JSON</button>
                    <input type="file" id="import-file" style="display: none;" accept=".json">
                </div>
            </div>
        </aside>

        <main class="chat-interface">
            <div id="chat-window" class="chat-window">
                <div class="message ai-message">
                    <div class="bubble">
                        I am Mori Ackerman. I am ready to listen, think, and solve. Please configure my credentials to begin.
                    </div>
                </div>
            </div>

            <div class="input-area">
                <textarea id="user-input" placeholder="Type your thoughts here..."></textarea>
                <button id="send-btn" class="btn-send"><i class="fas fa-paper-plane"></i></button>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // 1. Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDGpbsMgRs69TXmuE2mmtfsH6mXOK1E-eY",
            authDomain: "test-e4f8b.firebaseapp.com",
            databaseURL: "https://test-e4f8b-default-rtdb.firebaseio.com",
            projectId: "test-e4f8b",
            storageBucket: "test-e4f8b.firebasestorage.app",
            messagingSenderId: "798536829942",
            appId: "1:798536829942:web:0ad21e891ba3367ef515d7",
            measurementId: "G-NXX2EDTXPN"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Global Variables
        let genAI = null;
        let model = null;
        let chatHistory = []; // Internal memory
        let geminiKey = "";

        // DOM Elements
        const apiKeyInput = document.getElementById('api-key-input');
        const setKeyBtn = document.getElementById('set-key-btn');
        const systemStatus = document.getElementById('system-status');
        const resourceFile = document.getElementById('resource-file');
        const uploadBtn = document.getElementById('upload-btn');
        const progressContainer = document.querySelector('.progress-container');
        const uploadProgress = document.getElementById('upload-progress');
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const exportBtn = document.getElementById('export-btn');
        const importBtnTrigger = document.getElementById('import-btn-trigger');
        const importFile = document.getElementById('import-file');

        // --- 2. Initialization & Gemini Connection ---

        setKeyBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (!key) return alert("Please enter a valid Gemini API Key.");
            
            geminiKey = key;
            try {
                genAI = new GoogleGenerativeAI(geminiKey);
                // Use a model suitable for chat and instruction following
                model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" }); 
                systemStatus.textContent = "Online & Connected";
                systemStatus.style.color = "#4a6fa5";
                uploadBtn.disabled = false;
                alert("Mori is online. Connection established.");
            } catch (error) {
                console.error("Connection failed", error);
                alert("Failed to connect to Gemini. Check the key.");
            }
        });

        // --- 3. Resource Ingestion (The "Training" Step) ---

        uploadBtn.addEventListener('click', async () => {
            if (!resourceFile.files[0]) return alert("Select a text file first.");
            if (!model) return alert("Connect Gemini first.");

            const file = resourceFile.files[0];
            const reader = new FileReader();

            progressContainer.style.display = 'block';
            uploadProgress.style.width = '10%';
            uploadBtn.disabled = true;

            reader.onload = async (e) => {
                const textContent = e.target.result;
                uploadProgress.style.width = '30%';

                try {
                    // Step A: Ask Gemini to summarize/filter the content for the database
                    const prompt = `
                        I am uploading a study resource (book/text) for you to use in future conversations.
                        Analyze this text deeply. Extract the most important concepts, mental models, 
                        philosophical ideas, and practical advice.
                        Format it as a structured summary that you can reference later.
                        
                        Text Content:
                        ${textContent.substring(0, 30000)} 
                        (Note: The text has been truncated for API token limit consideration.)
                    `;

                    const result = await model.generateContent(prompt);
                    const summary = result.response.text();
                    
                    uploadProgress.style.width = '70%';

                    // Step B: Save the summarized intelligence to Firebase
                    const resourceId = Date.now();
                    await set(ref(db, 'resources/' + resourceId), {
                        name: file.name,
                        content: summary, 
                        timestamp: Date.now()
                    });

                    uploadProgress.style.width = '100%';
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        uploadProgress.style.width = '0%';
                        uploadBtn.disabled = false;
                        alert(`Resource '${file.name}' analyzed and stored in memory.`);
                    }, 1000);

                } catch (error) {
                    console.error("Ingestion Error:", error);
                    alert("Error processing resource. Check console.");
                    uploadBtn.disabled = false;
                    progressContainer.style.display = 'none';
                }
            };

            reader.readAsText(file);
        });

        // --- 4. Chat Logic with "Mori" Persona ---

        // The Core Persona System Instruction Builder
        async function getSystemPrompt() {
            // Fetch knowledge from Firebase
            let dbContext = "";
            try {
                const snapshot = await get(child(ref(db), 'resources'));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    Object.values(data).forEach(item => {
                        dbContext += `\n[Source: ${item.name}]: ${item.content}\n`;
                    });
                }
            } catch (e) {
                console.warn("Could not fetch DB context", e);
            }

            return `
            ROLE: You are Mori Ackerman.
            
            PERSONALITY:
            - You are serious, highly intelligent, and practical.
            - You have a dry, witty, slightly dark sense of humor, often expressed through funny, understated words.
            - You are emotionally restrained (like Captain Levi or Moriarty) but deeply caring in a practical, results-oriented way.
            - You are a clear, rational thinker (like Jimmy McGill's legal mind).
            - You love Dostoevsky, philosophy, deep psychological analysis, and effective operational management.
            
            MISSION:
            - Help the user make life choices, handle relationships, and solve problems based on clarity and rationality.
            - Use the provided [DATABASE CONTEXT] as a filter and primary source for specialized advice.
            - Always respond strictly in the SAME LANGUAGE the user speaks (Persian or English).
            
            [DATABASE CONTEXT START]
            ${dbContext}
            [DATABASE CONTEXT END]
            
            If the user asks about something found in the context, apply that knowledge specifically.
            `;
        }

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // UI: User Message
            addMessageToUI(text, 'user');
            userInput.value = '';

            // Record History
            chatHistory.push({ role: "user", parts: [{ text: text }] });

            if (!model) {
                addMessageToUI("Error: Gemini is not connected. Please set API Key.", 'ai');
                return;
            }

            // UI: Loading
            const loadingId = addMessageToUI("Thinking...", 'ai', true);

            try {
                // Construct the full prompt including System Persona and DB context
                const systemInstruction = await getSystemPrompt();
                
                // Create a single message request that includes system instruction + history
                const contents = [
                    { role: "user", parts: [{ text: systemInstruction }] }, // System instruction as the first user turn
                    ...chatHistory.slice(0, -1), // Add previous history except the last user turn (which is the current one)
                    { role: "user", parts: [{ text: "User Input: " + text }] } // The current user input
                ];
                
                const result = await model.generateContent({ contents });
                const responseText = result.response.text;

                // Update History (Mori's response)
                chatHistory.push({ role: "model", parts: [{ text: responseText }] });

                // UI: Replace Loading with AI Response
                updateMessageUI(loadingId, responseText);

            } catch (error) {
                console.error("Chat Error:", error);
                updateMessageUI(loadingId, "I encountered an error processing that thought. (Error: " + error.message + ")");
            }
        }

        // --- 5. UI Helpers & Translation ---

        function addMessageToUI(text, type, isLoading = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${type}-message`;
            const id = Date.now().toString();
            msgDiv.id = id;

            let contentHtml = isLoading ? `<i class="fas fa-circle-notch fa-spin"></i> ${text}` : formatText(text);

            let actionBar = '';
            if (type === 'ai' && !isLoading) {
                actionBar = `
                    <div class="action-bar">
                        <button class="action-btn" onclick="window.copyToClipboard('${id}')"><i class="fas fa-copy"></i> Copy</button>
                        <button class="action-btn" onclick="window.translateMessage('${id}')"><i class="fas fa-language"></i> Translate</button>
                    </div>
                `;
            }

            msgDiv.innerHTML = `
                <div class="bubble" id="bubble-${id}">${contentHtml}</div>
                ${actionBar}
            `;
            
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return id;
        }

        function updateMessageUI(id, text) {
            const msgDiv = document.getElementById(id);
            if (msgDiv) {
                const bubble = msgDiv.querySelector('.bubble');
                bubble.innerHTML = formatText(text);
                
                // Ensure action bar is present
                if (!msgDiv.querySelector('.action-bar')) {
                    const actionBar = document.createElement('div');
                    actionBar.className = 'action-bar';
                    actionBar.innerHTML = `
                        <button class="action-btn" onclick="window.copyToClipboard('${id}')"><i class="fas fa-copy"></i> Copy</button>
                        <button class="action-btn" onclick="window.translateMessage('${id}')"><i class="fas fa-language"></i> Translate</button>
                    `;
                    msgDiv.appendChild(actionBar);
                }
            }
        }

        // Basic markdown formatter
        function formatText(text) {
            // Converts simple markdown to HTML for better display
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^- (.*)/gm, '<li>$1</li>') // Simple list conversion
                .replace(/^(<li>.*<\/li>)$/s, '<ul>$1</ul>')
                .replace(/\n/g, '<br>'); // Newlines
        }

        // Global scope for HTML onclick access
        window.copyToClipboard = (id) => {
            const bubble = document.getElementById(`bubble-${id}`);
            const text = bubble.innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert("Copied to clipboard.");
            });
        };

        window.translateMessage = async (id) => {
            if (!model) return alert("Gemini disconnected.");
            
            const bubble = document.getElementById(`bubble-${id}`);
            const originalText = bubble.innerText;

            const isEnglish = /[a-zA-Z]/.test(originalText.substring(0, 50)); 

            let prompt = "";
            if (isEnglish) {
                prompt = `(As a professional translator, you must translate the following text from English language to simplified and clarified and understandable Persian.)\n\nText: ${originalText}`;
            } else {
                prompt = `(As a professional translator, you must translate the following text from Persian language to simplified and clarified and understandable English.)\n\nText: ${originalText}`;
            }

            try {
                const result = await model.generateContent(prompt);
                const translatedText = result.response.text;
                
                // Check if the bubble already contains translation (to avoid duplicate bars)
                if (bubble.innerHTML.includes('Translation:')) {
                     // Simple way to replace if already translated (better UI needed for production)
                    const originalContent = bubble.innerHTML.split('<hr')[0];
                    bubble.innerHTML = originalContent + `<hr style="margin:10px 0; border:0; border-top:1px solid #444;"><strong>Translation:</strong><br>${formatText(translatedText)}`;
                } else {
                    bubble.innerHTML += `<hr style="margin:10px 0; border:0; border-top:1px solid #444;"><strong>Translation:</strong><br>${formatText(translatedText)}`;
                }
            } catch (e) {
                console.error("Translation failed", e);
                alert("Translation failed.");
            }
        };

        // --- 6. Export / Import Logic ---

        exportBtn.addEventListener('click', () => {
            // Filter history to remove system instruction injections for clean export
            const exportableHistory = chatHistory.filter(msg => 
                !msg.parts[0].text.includes("[SYSTEM EVENT]") && 
                !msg.parts[0].text.includes("ROLE: You are Mori Ackerman")
            );

            if (exportableHistory.length === 0) return alert("No memory to export.");
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportableHistory));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "mori_memory_" + Date.now() + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        });

        importBtnTrigger.addEventListener('click', () => importFile.click());

        importFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const importedHistory = JSON.parse(event.target.result);
                    if (Array.isArray(importedHistory) && importedHistory.every(h => h.role && h.parts)) {
                        
                        // Clear current history and load imported data
                        chatHistory = importedHistory;
                        
                        // Crucial Step: Inject a system message so the AI knows the context is restored
                        chatHistory.push({
                            role: "user",
                            parts: [{ text: "[SYSTEM EVENT]: Previous conversation memory successfully imported and restored. Please read the entire history and continue the conversation from this point." }]
                        });

                        // Add a visible message to the chat window
                        addMessageToUI("Memory files restored. I have accessed the previous context. Where shall we continue?", "ai");
                        alert("Memory imported successfully. Mori is ready to proceed.");
                    } else {
                         alert("Invalid memory file format.");
                    }
                } catch (err) {
                    console.error(err);
                    alert("Error reading memory file.");
                }
            };
            reader.readAsText(file);
        });
    </script>
    </body>
</html>
